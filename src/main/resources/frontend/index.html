<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<body>
<canvas id="myChart" style="width:100%;max-width:600px"></canvas>
<h4>Extra Info</h4>
<h5>Proximity Alerts:</h5>
<h6 id="alerts"></h6>
<h5>Vessels Info:</h5>
<h6 id="extraInfo"></h6>

<script>
    var chart;
    initializeData();

    function initializeData() {
        chart = new Chart("myChart", {
          type: "scatter",
          options: {
            legend: {display: true},
            title: {
               display: true,
               text: 'OneOcean vessel chart.'
            },
          }
        });

        chart.data.labels = new Set();

        fetch('/api/vessels')
            .then(response => response.json())
            .then(data => fetchVessels(data));

        fetch('/api/alerts')
            .then(response => response.json())
            .then(data => updateAlerts(data));
    }

    function updateAlerts(alerts) {
        alerts.forEach(element => {
                var para = document.createElement("p");
                para.innerHTML = "Timestamp: " + element.timestamp;
                document.getElementById("alerts").appendChild(para);
                para = document.createElement("p");
                para.innerHTML = "Location: " + element.location.xKm + " " + element.location.yKm;
                document.getElementById("alerts").appendChild(para);
                para = document.createElement("p");
                para.innerHTML = "Location: " + element.vessels;
                document.getElementById("alerts").appendChild(para);
                document.getElementById("alerts").appendChild(document.createElement("br"));
            })
    }

    function fetchVessels(vessels) {
        vessels.forEach(vessel => {
            fetch('/api/' + vessel + '/gpsTrack/')
                .then(response => response.json())
                .then(data => pushToChart(data));
            fetch('/api/' + vessel + '/averageSpeed/')
                .then(response => response.json())
                .then(data => updateVesselSpeed(data));
            fetch('/api/' + vessel + '/distanceTraveled/')
                .then(response => response.json())
                .then(data => updateVesselDistance(data));
        })
    }

    function updateVesselSpeed(data) {
        var vesselInfo = getContainerOrCreate(data.name)

        var para = document.createElement("p");
        para.innerHTML = "Average Speed: " + data.averageSpeedKph;
        vesselInfo.appendChild(para);
    }

    function updateVesselDistance(data) {
        var vesselInfo = getContainerOrCreate(data.name)

        var para = document.createElement("p");
        para.innerHTML = "Distance Traveled Km: " + data.distanceTraveledKm;
        vesselInfo.appendChild(para);
    }

    function getContainerOrCreate(vesselName) {
        var vesselInfo = document.getElementById(vesselName)
        if (vesselInfo == null) {
            vesselInfo = document.createElement("p");
            vesselInfo.setAttribute("id", vesselName);
            vesselInfo.innerHTML = vesselName;
            document.getElementById("extraInfo").appendChild(vesselInfo);
        }

        return vesselInfo;
    }

    function pushToChart(data) {
        var xData = new Array();
        var yData = new Array();

        var newDataset = {
            label: data.name,
            fill: false,
            showLine: true,
            backgroundColor: getRandomColor(),
            borderColor: getRandomColor(),
            data: []
        };
        data.gpsTrack.forEach((element) => {
            newDataset.data.push({x: element.xKm, y: element.yKm});
        });
        chart.data.datasets.push(newDataset);
        chart.update();
    }

    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
</script>

</body>
</html>
